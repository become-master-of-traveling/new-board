<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>æ—…éŠç•™è¨€ç‰† Sticky Notes Wall</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- é¦–é é¸å–® -->
<div id="menu" class="menu">
    <h1>æ—…éŠç•™è¨€ç‰†</h1>
    <button onclick="showWall()">æŸ¥çœ‹ç•™è¨€ç‰†</button>
    <button onclick="showInput()">æˆ‘è¦ç•™è¨€</button>
</div>

<!-- ç•™è¨€è¼¸å…¥å€ -->
<div id="inputPage" class="hidden">
    <h1 class="title">æˆ‘è¦ç•™è¨€</h1>
    <button class="back" onclick="showMenu()">è¿”å›é¸å–®</button>
    <button class="wallPage" onclick="showWall()">ç•™è¨€ç‰†</button>

    <div class="input-box">
        <input id="name" type="text" placeholder="ä½ çš„åå­—ï¼ˆä¾‹å¦‚ï¼šAmyã€Huixinã€Chiuï¼‰" />
        <textarea id="content" placeholder="æƒ³èªªäº›ä»€éº¼å‘¢ï¼Ÿ" rows="3"></textarea>
        <button onclick="addMessage()">é€å‡ºç•™è¨€</button>
    </div>
</div>

<!-- ç•™è¨€ç‰† -->
<div id="wallPage" class="hidden">
    <h1 class="title">ç•™è¨€ç‰†</h1>
    <button class="back" onclick="showMenu()">è¿”å›é¸å–®</button>
    <button class="inputPage" onclick="showInput()">ç•™è¨€å€</button>

    <div id="messages"></div>
</div>


<script>
const API_BASE = "http://localhost:3000";

// --------------------- åˆ‡æ›é é¢ ----------------------

function showMenu() {
  document.getElementById("menu").classList.remove("hidden");
  document.getElementById("inputPage").classList.add("hidden");
  document.getElementById("wallPage").classList.add("hidden");
}

function showInput() {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("inputPage").classList.remove("hidden");
  document.getElementById("wallPage").classList.add("hidden");
}

// æ‰“é–‹ç•™è¨€ç‰† â†’ å¾ DB è¼‰å…¥
function showWall() {
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("inputPage").classList.add("hidden");
  document.getElementById("wallPage").classList.remove("hidden");
  loadMessagesFromDB();
}

// --------------------- ä¸»è³‡æ–™ï¼šä¾†è‡ªå¾Œç«¯ ----------------------

let messages = [];

// å¾å¾Œç«¯è¼‰å…¥å…¨éƒ¨ç•™è¨€
async function loadMessagesFromDB() {
  try {
    const res = await fetch(`${API_BASE}/api/notes`);
    const data = await res.json();

    // å°‡å¾Œç«¯æ ¼å¼è½‰æˆå‰ç«¯ä¾¿åˆ©è²¼æ ¼å¼
    messages = data.map(note => ({
      id: note._id,                     
      name: note.author || "åŒ¿å",
      content: note.content,
      time: new Date(note.createdAt).toLocaleString(),
      likes: 0,     
      replies: []  
    }));

    render();
  } catch (err) {
    console.error("è¼‰å…¥ç•™è¨€å¤±æ•—ï¼š", err);
    alert("ç„¡æ³•è¼‰å…¥ç•™è¨€ï¼Œè«‹ç¨å¾Œå†è©¦");
  }
}

// --------------------- æ–°å¢ç•™è¨€ï¼ˆPOST APIï¼‰ ----------------------

async function addMessage() {
  const name = document.getElementById("name").value.trim();
  const content = document.getElementById("content").value.trim();

  if (!name || !content) {
    alert("è«‹è¼¸å…¥åå­—èˆ‡ç•™è¨€å…§å®¹ï¼");
    return;
  }

  try {
    // å°‡ç•™è¨€é€åˆ° MongoDB
    const res = await fetch(`${API_BASE}/api/notes`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        author: name,
        content: content,
      }),
    });

    if (!res.ok) {
      alert("ç•™è¨€é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      return;
    }

    // é€å‡ºæˆåŠŸå¾Œï¼Œé‡æ–°å–å¾—æœ€æ–°ç•™è¨€
    await loadMessagesFromDB();

    // æ¸…ç©ºè¼¸å…¥æ¡†
    document.getElementById("content").value = "";

    alert("ç•™è¨€æˆåŠŸï¼");

  } catch (err) {
    console.error("æ–°å¢ç•™è¨€éŒ¯èª¤ï¼š", err);
    alert("ç„¡æ³•é€å‡ºç•™è¨€");
  }
}

// --------------------- ä¾¿åˆ©è²¼ç•«é¢æ¸²æŸ“ ----------------------

function render() {
  const box = document.getElementById("messages");
  box.innerHTML = "";

  const colors = ["var(--sticky1)", "var(--sticky2)", "var(--sticky3)", "var(--sticky4)", "var(--sticky5)"];

  messages.forEach((msg, i) => {
    const bg = colors[Math.floor(Math.random() * colors.length)];
    const rotate = Math.floor(Math.random() * 11) - 5;

    box.innerHTML += `
      <div class="message" style="background:${bg}; --rotate:${rotate}">
          <strong>${msg.name}</strong>
          <div class="time">${msg.time}</div>
          <div class="content">${msg.content}</div>

          <div class="actions">
            <span class="like" onclick="likeMessage(${i})">â¤ï¸ ${msg.likes}</span>
            <span class="reply-btn" onclick="addReply(${i})">ğŸ’­ å›è¦†</span>
            <span class="delete-btn" onclick="deleteMessage(${i})">ğŸ—‘ï¸ åˆªé™¤</span>
          </div>

          ${msg.replies.map(r => `<div class="reply-box">ğŸ’¬ ${r}</div>`).join("")}
      </div>
    `;
  });
}

// --------------------- è®šã€åˆªé™¤ã€å›è¦†ï¼ˆå…ˆç•™åœ¨å‰ç«¯ï¼‰ ----------------------

function likeMessage(index) {
  messages[index].likes++;
  render();
}

async function deleteMessage(index) {
  const msg = messages[index];
  if (!msg || !msg.id) {
    alert("æ‰¾ä¸åˆ°é€™å‰‡ç•™è¨€çš„ idï¼Œç„¡æ³•åˆªé™¤");
    return;
  }

  if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€å—ï¼Ÿ")) {
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/notes/${msg.id}`, {
      method: "DELETE",
    });

    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      console.error("åˆªé™¤å¤±æ•—ï¼š", errData);
      alert("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      return;
    }

    // æœ¬åœ°é™£åˆ—åŒæ­¥åˆªé™¤
    messages.splice(index, 1);
    render();
  } catch (err) {
    console.error("åˆªé™¤ç•™è¨€æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
    alert("åˆªé™¤ç•™è¨€å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
  }
}

function addReply(index) {
  const reply = prompt("è¼¸å…¥å›è¦†å…§å®¹ï¼š");
  if (reply) {
    messages[index].replies.push(reply);
    render();
  }
}

</script>